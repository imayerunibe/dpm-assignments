---
title: "Examining the relationship between the big-5 personality facets and implicit racial attitudes"
subtitle: "Data Analysis"
author: "Template: Ian Hussey; content: Isabel Mayer"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: hide
    highlight: haddock
    theme: flatly
    toc: yes
    toc_float: yes
---

```{r, include=FALSE}

# set knit options
knitr::opts_chunk$set(message = FALSE,
                      warning = FALSE)

# disable scientific notation
options(scipen = 999) 

```

# Dependencies

```{r}

library(tidyverse)
library(knitr)
library(kableExtra)
library(janitor)
library(scales)
library(psych)
library(report)
library(patchwork)
library(ggplot2)
library(dplyr)


```

# Data

Load the processed data and apply the global exclusions.

```{r}
# Reading the data
data_processed <- read_csv("../data/processed/data_processed.csv")

# Applying the exclusions
data_processed_after_exclusions <- data_processed |>
  filter(exclude_participant == "include")
```

# Sample descriptives

## Sample size before exclusions

```{r}
# Creating a table with the sample size before the exclusions
data_processed |>
  count(name = "n") |>
  kable() |>
  add_header_above(header = c("Sample Size Before Exclusion" = 1)) |> 
  kable_classic(full_width = FALSE)

```

## Sample size after exclusions

Sample used in subsequent analyses

```{r}
# Creating a table with the sample size after the exclusions
data_processed_after_exclusions |>
  count(name = "n") |>
  kable() |>
  add_header_above(header = c("Sample Size After Exclusion" = 1)) |>
  kable_classic(full_width = FALSE)

```

## Age

```{r}
# Creating a table with mean and SD of age
data_processed_after_exclusions |>
  mutate(age = as.numeric(age)) |>
  summarise(Mean = mean(age, na.rm = TRUE),
            SD = sd(age, na.rm = TRUE)) |>
  mutate_all(.funs = janitor::round_half_up, digits = 1) |>
  kable() |>
  add_header_above(header = c("Age" = 2)) |>
  kable_classic(full_width = FALSE)

```

## Gender

```{r}
# Creating a table with number and proportions of gender
data_processed_after_exclusions |> 
  group_by(sex) |> 
  summarise(n = n()) |> 
  mutate(Percent = paste0(round_half_up((n / sum(n)) * 100, 1), "%")) |>
  kable() |>
  kable_classic(full_width = FALSE)

```

# Descriptives

Descriptive statistics and plots of the measures (excluding the demographics variables)

## BFI

### Cronbach's Alpha

```{r}
# Specifying the columns for each subscale
bfi_a_items <- c("bfi_a1", "bfi_a2", "bfi_a3", "bfi_a4", "bfi_a5", "bfi_a6", "bfi_a7", "bfi_a8", "bfi_a9")
bfi_c_items <- c("bfi_c1", "bfi_c2", "bfi_c3", "bfi_c4", "bfi_c5", "bfi_c6", "bfi_c7", "bfi_c8", "bfi_c9")
bfi_e_items <- c("bfi_e1", "bfi_e2", "bfi_e3", "bfi_e4", "bfi_e5", "bfi_e6", "bfi_e7", "bfi_e8")
bfi_n_items <- c("bfi_n1", "bfi_n2", "bfi_n3", "bfi_n4", "bfi_n5", "bfi_n6", "bfi_n7", "bfi_n8")
bfi_o_items <- c("bfi_o1", "bfi_o2", "bfi_o3", "bfi_o4", "bfi_o5", "bfi_o6", "bfi_o7", "bfi_o8", "bfi_o9", "bfi_o10")

# Extracting the relevant columns from data_processed
bfi_a_data <- data_processed_after_exclusions[bfi_a_items]
bfi_c_data <- data_processed_after_exclusions[bfi_c_items]
bfi_e_data <- data_processed_after_exclusions[bfi_e_items]
bfi_n_data <- data_processed_after_exclusions[bfi_n_items]
bfi_o_data <- data_processed_after_exclusions[bfi_o_items]

# Calculating Cronbach's alpha for each subscale
alpha_a <- alpha(bfi_a_data)
alpha_a
alpha_c <- alpha(bfi_c_data)
alpha_c
alpha_e <- alpha(bfi_e_data)
alpha_e
alpha_n <- alpha(bfi_n_data)
alpha_n
alpha_o <- alpha(bfi_o_data)
alpha_o

```

### Descriptive plot

```{r}
# Creating a histogram for each subscale of the BFI
## Agreeableness Mean
ggplot(data_processed_after_exclusions, aes(x = mean_agreeableness)) +
  geom_histogram(binwidth = 0.2,
                 boundary = 0,
                 fill = viridis_pal(begin = 0.45, option = "mako")(1), 
                 color = viridis_pal(begin = 0.30, option = "mako")(1)) + 
  xlab("Agreeableness") +
  ylab("Frequency") +
  theme_linedraw() +
  scale_x_continuous(breaks = pretty_breaks(n = 10))

## Conscientiousness Mean
ggplot(data_processed_after_exclusions, aes(x = mean_conscientiousness)) +
  geom_histogram(binwidth = 0.2,
                 boundary = 0,
                 fill = viridis_pal(begin = 0.45, option = "mako")(1), 
                 color = viridis_pal(begin = 0.30, option = "mako")(1)) + 
  xlab("Conscientiousness") +
  ylab("Frequency") +
  theme_linedraw() +
  scale_x_continuous(breaks = pretty_breaks(n = 10))

## Extraversion Mean
ggplot(data_processed_after_exclusions, aes(x = mean_extraversion)) +
  geom_histogram(binwidth = 0.2,
                 boundary = 0,
                 fill = viridis_pal(begin = 0.45, option = "mako")(1), 
                 color = viridis_pal(begin = 0.30, option = "mako")(1)) + 
  xlab("Extraversion") +
  ylab("Frequency") +
  theme_linedraw() +
  scale_x_continuous(breaks = pretty_breaks(n = 10))

## Neuroticism Mean
ggplot(data_processed_after_exclusions, aes(x = mean_neuroticism)) +
  geom_histogram(binwidth = 0.2,
                 boundary = 0,
                 fill = viridis_pal(begin = 0.45, option = "mako")(1), 
                 color = viridis_pal(begin = 0.30, option = "mako")(1)) + 
  xlab("Neuroticism") +
  ylab("Frequency") +
  theme_linedraw() +
  scale_x_continuous(breaks = pretty_breaks(n = 10))

## Openness Mean
ggplot(data_processed_after_exclusions, aes(x = mean_openness)) +
  geom_histogram(binwidth = 0.2,
                 boundary = 0,
                 fill = viridis_pal(begin = 0.45, option = "mako")(1), 
                 color = viridis_pal(begin = 0.30, option = "mako")(1)) + 
  xlab("Openness") +
  ylab("Frequency") +
  theme_linedraw() +
  scale_x_continuous(breaks = pretty_breaks(n = 10))

#
```
## AIT
### Descriptive plot

```{r}
# Creating a Histogram for AIT scores
ggplot(data_processed_after_exclusions, aes(x = iat_D_score)) +
  geom_histogram(binwidth = 0.1,
                 boundary = 0,
                 fill = viridis_pal(begin = 0.45, option = "mako")(1), 
                 color = viridis_pal(begin = 0.30, option = "mako")(1)) + 
  xlab("D Scores") +
  ylab("Frequency") +
  theme_linedraw() +
  scale_x_continuous(breaks = pretty_breaks(n = 10))
```

# Analyses & hypothesis tests

## Correlation
Correlation matrix of the Pearson's r correlations between the IAT and the BFI subscales rounded to two decimal places.
```{r}
# Extracting relevant columns
iat_vars <- data_processed[, c("iat_D_score")]
bfi_vars <- data_processed[, c("mean_agreeableness", "mean_conscientiousness", "mean_openness", "mean_neuroticism", "mean_extraversion")]

# Calculating the correlation matrix
cor_matrix <- cor(bfi_vars, iat_vars, use = "pairwise.complete.obs") |>
  round(2) # Rounding the correlation matrix to two decimal places

# Set row names for the correlation matrix
rownames(cor_matrix) <- c("Agreeableness", "Conscientiousness", "Openness", "Neuroticism", "Extraversion")

print(cor_matrix)
```

## T-Test
Test the hypothesis that men and women differ on their scores on the IAT.
```{r}
# Subseting the data for men and women
data_men <- data_processed_after_exclusions[data_processed_after_exclusions$sex == "m", "iat_D_score"]
data_women <- data_processed_after_exclusions[data_processed_after_exclusions$sex == "f", "iat_D_score"]

# Performing a t-test
t_test_result <- t.test(data_men, data_women)

print(t_test_result)

# Generatinng a report
report(t.test(data_men, data_women))

```
The Welch Two Sample t-test testing the difference
between data_men and data_women (mean of x =
-0.25, mean of y = -0.22) suggests that the effect
is negative, statistically not significant, and
very small (difference = -0.03, 95% CI [-0.16,
0.11], t(61.09) = -0.38, p = 0.706; Cohen's d =
-0.10, 95% CI [-0.60, 0.41]).

## Regressions
Test the hypotheses that each BFI subscale predicts IAT scores.
```{r}
# Agreeableness

## Running the regression
model_a <- lm(iat_D_score ~ mean_agreeableness, data = data_processed_after_exclusions)
model_a

## Reporting the result
report(model_a)

# Conscientiousness

## Running the regression
model_c <- lm(iat_D_score ~ mean_conscientiousness, data = data_processed_after_exclusions)
model_c

## Reporting the result
report(model_c)

# Extraversion

## Running the regression
model_e <- lm(iat_D_score ~ mean_extraversion, data = data_processed_after_exclusions)
model_e

## Reporting the result
report(model_e)

# Neuroticism

## Running the regression
model_n <- lm(iat_D_score ~ mean_neuroticism, data = data_processed_after_exclusions)
model_n

## Reporting the result
report(model_n)

# Openness
## Running the regression
model_o <- lm(iat_D_score ~ mean_openness, data = data_processed_after_exclusions)
model_o

## Reporting the result
report(model_o)
```

# Plots

## Prediction of IAT Scores
```{r}
# Creating a new column for extreme values
data_processed_after_exclusions <- data_processed_after_exclusions %>%
    mutate(extreme_D_score = ifelse(iat_D_score <= quantile(iat_D_score, 0.1) | iat_D_score >= quantile(iat_D_score, 0.9), "extreme", "normal"))
                            
# Creating a scatter plot for each subscale

## Agreeableness
scatter_plot_agreeableness <- ggplot(data_processed_after_exclusions, aes_string(x = "mean_agreeableness", y = "iat_D_score")) +
    geom_point(aes(shape = ifelse(extreme_D_score == "extreme", "triangle", "circle")), size = 2) +
    geom_smooth(method = "lm", se = TRUE, color = "blue") +
    labs(title = paste("Prediction of IAT Scores by Agreeableness"), x = "Agreeableness", y = "IAT Score") +
  scale_x_continuous(breaks=seq(1, 6, 1), limits = c(1, 6)) +
  scale_y_continuous(breaks=seq(-2, 2, 1), limits=c(-2, 2)) +
    theme_minimal() +
    theme(legend.position = "none", plot.title = element_text(hjust = 0.5))

scatter_plot_agreeableness

## Conscientiousness

scatter_plot_conscientiousness <- ggplot(data_processed_after_exclusions, aes_string(x = "mean_conscientiousness", y = "iat_D_score")) +
  scale_x_continuous(breaks=seq(1, 6, 1), limits = c(1, 6)) +
  scale_y_continuous(breaks=seq(-2, 2, 1), limits=c(-2, 2)) +
    geom_point(aes(shape = ifelse(extreme_D_score == "extreme", "triangle", "circle")), size = 2) +
    geom_smooth(method = "lm", se = TRUE, color = "blue") +
    labs(title = paste("Prediction of IAT Scores by Conscientiousness"), x = "Conscientiousness", y = "IAT Score") +
    theme_minimal() +
    theme(legend.position = "none", plot.title = element_text(hjust = 0.5))

scatter_plot_conscientiousness

## Extraversion

scatter_plot_extraversion <- ggplot(data_processed_after_exclusions, aes_string(x = "mean_extraversion", y = "iat_D_score")) +
  scale_x_continuous(breaks=seq(1, 6, 1), limits = c(1, 6)) +
  scale_y_continuous(breaks=seq(-2, 2, 1), limits=c(-2, 2)) +
    geom_point(aes(shape = ifelse(extreme_D_score == "extreme", "triangle", "circle")), size = 2) +
    geom_smooth(method = "lm", se = TRUE, color = "blue") +
    labs(title = paste("Prediction of IAT Scores by Extraversion"), x = "Extraversion", y = "IAT Score") +
    theme_minimal() +
    theme(legend.position = "none", plot.title = element_text(hjust = 0.5))

scatter_plot_extraversion

## Neuroticism


scatter_plot_neuroticism <- ggplot(data_processed_after_exclusions, aes_string(x = "mean_neuroticism", y = "iat_D_score")) +
  scale_x_continuous(breaks=seq(1, 6, 1), limits = c(1, 6)) +
  scale_y_continuous(breaks=seq(-2, 2, 1), limits=c(-2, 2)) +
    geom_point(aes(shape = ifelse(extreme_D_score == "extreme", "triangle", "circle")), size = 2) +
    geom_smooth(method = "lm", se = TRUE, color = "blue") +
    labs(title = paste("Prediction of IAT Scores by Neuroticism"), x = "Neuroticism", y = "IAT Score") +
    theme_minimal() +
    theme(legend.position = "none", plot.title = element_text(hjust = 0.5))

scatter_plot_neuroticism

## Openness

scatter_plot_openness <- ggplot(data_processed_after_exclusions, aes_string(x = "mean_openness", y = "iat_D_score")) +
  scale_x_continuous(breaks=seq(1, 6, 1), limits = c(1, 6)) +
  scale_y_continuous(breaks=seq(-2, 2, 1), limits=c(-2, 2)) +
    geom_point(aes(shape = ifelse(extreme_D_score == "extreme", "triangle", "circle")), size = 2) +
    geom_smooth(method = "lm", se = TRUE, color = "blue") +
    labs(title = paste("Prediction of IAT Scores by Openness"), x = "Openness", y = "IAT Score") +
    theme_minimal() +
    theme(legend.position = "none", plot.title = element_text(hjust = 0.5))

scatter_plot_openness
```

## Combining plots

```{r}
# Combining the plots using patchwork
combined_plot <- scatter_plot_agreeableness +
  scatter_plot_conscientiousness +
  scatter_plot_extraversion +
  scatter_plot_neuroticism +
  scatter_plot_openness +
  plot_layout(guides = "collect")

# Print the combined plot to the HTML file
print(combined_plot)
```

## Saving plots

```{r}
# Save the plot to disk
ggsave("../communications/combined_plot.png", plot = combined_plot, width = 12, height = 8)
ggsave("../communications/combined_plot.pdf", plot = combined_plot, width = 12, height = 8)
```


